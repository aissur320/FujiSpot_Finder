<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FujiSpot Finder</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            /* ä¼˜åŒ–äº†æ—¥è¯­å­—ä½“ */
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        /* æ‚¬æµ®æ§åˆ¶é¢æ¿æ ·å¼ */
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            z-index: 1000;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            width: 320px;
            max-height: 90vh;
            overflow-y: auto;
        }

        h2 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        p {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background-color: #2196F3;
        }

        button.secondary:hover {
            background-color: #1e88e5;
        }

        /* çŠ¶æ€æ  */
        #status {
            font-size: 13px;
            color: #444;
            margin-top: 15px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ccc;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            border: 2px dashed #bbb;
            background: #fdfdfd;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            color: #666;
            border-radius: 4px;
        }

        .upload-area:hover {
            border-color: #4CAF50;
            background: #f0fff0;
            color: #4CAF50;
        }
    </style>
</head>

<body>

    <div id="controls">
        <h2>ğŸ—» FujiSpot Finder</h2>
        <p>YOLOv8ã¨DBSCANã‚’ç”¨ã„ãŸ<br>å¯Œå£«å±±æ’®å½±ã‚¹ãƒãƒƒãƒˆç™ºè¦‹ã‚·ã‚¹ãƒ†ãƒ </p>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            ğŸ“· å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰<br>
            <span style="font-size:12px">(è‡ªå‹•èªè­˜ + GPSæŠ½å‡º)</span>
        </div>
        <input type="file" id="fileInput" style="display: none;" onchange="uploadImage()">

        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

        <button class="secondary" onclick="generateSimulatedData()">1. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (50ç‚¹)</button>
        <button onclick="fetchClusters()">2. ã‚¹ãƒãƒƒãƒˆåˆ†æå®Ÿè¡Œ (DBSCAN)</button>

        <div id="status">ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†ã€‚å¾…æ©Ÿä¸­...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. åˆå§‹åŒ–åœ°å›¾ (ä¸­å¿ƒè®¾åœ¨å¯Œå£«å±±-æ²³å£æ¹–åŒºåŸŸ)
        var map = L.map('map').setView([35.49, 138.75], 11);

        // åŠ è½½ OpenStreetMap åº•å›¾
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        var markers = []; // å­˜å‚¨åœ°å›¾ä¸Šçš„æ ‡è®°

        // --- åŠŸèƒ½ A: ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ® ---
        function generateSimulatedData() {
            updateStatus("â³ ãƒ©ãƒ³ãƒ€ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...");
            fetch('/simulate', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    updateStatus(`âœ… ${data.message}`);
                    fetchClusters(); // ç”Ÿæˆå®Œè‡ªåŠ¨åˆ·æ–°
                })
                .catch(err => updateStatus("âŒ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"));
        }

        // --- åŠŸèƒ½ B: è·å–å¹¶æ˜¾ç¤ºèšç±»ç»“æœ (æ ¸å¿ƒ) ---
        function fetchClusters() {
            updateStatus("ğŸ”„ DBSCANã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°åˆ†æã‚’å®Ÿè¡Œä¸­...");

            fetch('/clusters')
                .then(res => res.json())
                .then(data => {
                    // 1. æ¸…é™¤æ—§æ ‡è®°
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];

                    if (data.clusters && data.clusters.length === 0) {
                        updateStatus("âš ï¸ ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼ˆ3ç‚¹æœªæº€ï¼‰ã®ãŸã‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã§ãã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯åé›†ã—ã¦ãã ã•ã„ã€‚");
                        return;
                    }

                    updateStatus(`âœ… åˆ†æå®Œäº†: ${data.n_clusters_found} ç®‡æ‰€ã®æ’®å½±ã‚¹ãƒãƒƒãƒˆã‚’ç™ºè¦‹ (ç·ãƒ‡ãƒ¼ã‚¿æ•°: ${data.total_spots})`);

                    // 2. éå†æ‰€æœ‰ç‚¹å¹¶ç”»å›¾
                    data.data.forEach(spot => {
                        var color = '#777'; // å™ªå£°ç‚¹é»˜è®¤ç°è‰²
                        var radius = 5;
                        var opacity = 0.6;

                        // å¦‚æœå±äºæŸä¸ªåæ‰€ (cluster_id >= 0)
                        if (spot.cluster_id >= 0) {
                            // ç»™ä¸åŒçš„ç°‡åˆ†é…ä¸åŒçš„é¢œè‰²
                            var colors = ['#FF0000', '#0000FF', '#008000', '#FFA500', '#800080', '#00CED1'];
                            color = colors[spot.cluster_id % colors.length];
                            radius = 9;     // åæ‰€çš„ç‚¹å¤§ä¸€ç‚¹
                            opacity = 0.9;  // æ›´ä¸é€æ˜
                        }

                        // æ·»åŠ åœ†å½¢æ ‡è®°
                        var marker = L.circleMarker([spot.lat, spot.lon], {
                            color: 'white',      // æè¾¹ç™½è‰²
                            weight: 1,
                            fillColor: color,    // å¡«å……é¢œè‰²
                            fillOpacity: opacity,
                            radius: radius
                        }).addTo(map);

                        // --- 3. æ„å»ºå¼¹çª—å†…å®¹ (å›¾ç‰‡å±•ç¤ºé€»è¾‘) ---
                        var popupHtml = `
                            <div style="text-align:center; font-family:sans-serif;">
                                <div style="font-size:14px; margin-bottom:5px; color:${color}; font-weight:bold;">
                                    ${spot.cluster_id >= 0 ? "ğŸ“¸ æ’®å½±ã‚¹ãƒãƒƒãƒˆ #" + spot.cluster_id : "ãƒã‚¤ã‚ºç‚¹ (Noise)"}
                                </div>
                                <div style="font-size:12px; color:#666; margin-bottom:5px;">
                                    ãƒ‡ãƒ¼ã‚¿å…ƒ: ${spot.source} (ID: ${spot.id})
                                </div>
                        `;

                        // åªæœ‰å½“ filename å­˜åœ¨æ—¶ï¼Œæ‰æ˜¾ç¤ºå›¾ç‰‡æ ‡ç­¾
                        if (spot.filename) {
                            popupHtml += `
                                <img src="/static/uploads/${spot.filename}" 
                                     style="width:200px; height:auto; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.2); margin-top:5px;"
                                     alt="Fuji Photo">
                            `;
                        } else {
                            popupHtml += `<div style="color:#999; font-size:12px;">(ç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—)</div>`;
                        }

                        popupHtml += `</div>`; // é—­åˆdiv

                        marker.bindPopup(popupHtml);
                        markers.push(marker);
                    });
                })
                .catch(err => {
                    console.error(err);
                    updateStatus("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯èµ·å‹•ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ");
                });
        }

        // --- åŠŸèƒ½ C: ä¸Šä¼ å›¾ç‰‡æ£€æµ‹ ---
        function uploadImage() {
            var input = document.getElementById('fileInput');
            if (input.files.length === 0) return;

            var formData = new FormData();
            formData.append("image", input.files[0]);

            updateStatus("ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ & YOLOv8æ¤œå‡ºå®Ÿè¡Œä¸­...");

            fetch('/detect', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.is_fuji) {
                        if (data.has_gps) {
                            updateStatus(`ğŸ—» <b>å¯Œå£«å±±ã‚’æ¤œå‡ºï¼</b><br>GPSæŠ½å‡ºå®Œäº†ã€åœ°å›³ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
                            fetchClusters(); // æˆåŠŸååˆ·æ–°åœ°å›¾
                        } else {
                            updateStatus(`ğŸ—» <b>å¯Œå£«å±±ã‚’æ¤œå‡º</b><br>âš ï¸ GPSæƒ…å ±ãŒãªã„ãŸã‚ä½ç½®ç‰¹å®šã§ãã¾ã›ã‚“ã€‚`);
                        }
                    } else {
                        updateStatus(`âŒ å¯Œå£«å±±ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ (YOLO Filtered)`);
                    }
                    // æ¸…ç©º input æ–¹ä¾¿ä¸‹æ¬¡ä¸Šä¼ åŒä¸€å¼ å›¾
                    input.value = '';
                })
                .catch(err => {
                    console.error(err);
                    updateStatus("âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                });
        }

        // æ›´æ–°çŠ¶æ€æ æ–‡å­—
        function updateStatus(htmlText) {
            var statusDiv = document.getElementById('status');
            statusDiv.innerHTML = htmlText;
            // å¦‚æœæ˜¯é”™è¯¯ä¿¡æ¯ï¼Œè¾¹æ¡†å˜çº¢ï¼›å¦åˆ™å˜ç°
            if (htmlText.includes("âŒ")) {
                statusDiv.style.borderLeftColor = "#ff4444";
            } else if (htmlText.includes("âœ…")) {
                statusDiv.style.borderLeftColor = "#4CAF50";
            } else {
                statusDiv.style.borderLeftColor = "#ccc";
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡æ•°æ®
        fetchClusters();
    </script>
</body>

</html>